window.jQuery&&function(b){b.fn.MultiFile=function(c){if(this.length==0)return this;if(typeof arguments[0]=="string"){if(this.length>1){var j=arguments;return this.each(function(){b.fn.MultiFile.apply(b(this),j)})}b.fn.MultiFile[arguments[0]].apply(this,b.makeArray(arguments).slice(1)||[]);return this}c=b.extend({},b.fn.MultiFile.options,c||{});b("form").not("MultiFile-intercepted").addClass("MultiFile-intercepted").submit(b.fn.MultiFile.disableEmpty);if(b.fn.MultiFile.options.autoIntercept){b.fn.MultiFile.intercept(b.fn.MultiFile.options.autoIntercept); b.fn.MultiFile.options.autoIntercept=null}this.not(".MultiFile-applied").addClass("MultiFile-applied").each(function(){window.MultiFile=(window.MultiFile||0)+1;var g=window.MultiFile,a={e:this,E:b(this),clone:b(this).clone()};if(typeof c=="number")c={max:c};var e=b.extend({},b.fn.MultiFile.options,c||{},(b.metadata?a.E.metadata():b.meta?a.E.data():null)||{},{});if(!(e.max>0)){e.max=a.E.attr("maxlength");if(!(e.max>0)){e.max=(String(a.e.className.match(/\b(max|limit)\-([0-9]+)\b/gi)||[""]).match(/[0-9]+/gi)|| [""])[0];e.max=e.max>0?String(e.max).match(/[0-9]+/gi)[0]:-1}}e.max=new Number(e.max);e.accept=e.accept||a.E.attr("accept")||"";if(!e.accept){e.accept=a.e.className.match(/\b(accept\-[\w\|]+)\b/gi)||"";e.accept=(new String(e.accept)).replace(/^(accept|ext)\-/i,"")}b.extend(a,e||{});a.STRING=b.extend({},b.fn.MultiFile.options.STRING,a.STRING);b.extend(a,{n:0,slaves:[],files:[],instanceKey:a.e.id||"MultiFile"+String(g),generateID:function(d){return a.instanceKey+(d>0?"_F"+String(d):"")},trigger:function(d, h){var i=a[d],f=b(h).attr("value");if(i){i=i(h,f,a);if(i!=null)return i}return true}});if(String(a.accept).length>1){a.accept=a.accept.replace(/\W+/g,"|").replace(/^\W|\W$/g,"");a.rxAccept=RegExp("\\.("+(a.accept?a.accept:"")+")$","gi")}a.wrapID=a.instanceKey+"_wrap";a.E.wrap('<div class="MultiFile-wrap" id="'+a.wrapID+'"></div>');a.wrapper=b("#"+a.wrapID+"");a.e.name=a.e.name||"file"+g+"[]";if(!a.list){a.wrapper.append('<div class="MultiFile-list" id="'+a.wrapID+'_list"></div>');a.list=b("#"+a.wrapID+ "_list")}a.list=b(a.list);a.addSlave=function(d,h){a.n++;d.MultiFile=a;if(h>0)d.id=d.name="";if(h>0)d.id=a.generateID(h);d.name=String(a.namePattern.replace(/\$name/gi,b(a.clone).attr("name")).replace(/\$id/gi,b(a.clone).attr("id")).replace(/\$g/gi,g).replace(/\$i/gi,h));if(a.max>0&&a.n-1>a.max)d.disabled=true;a.current=a.slaves[h]=d;d=b(d);d.val("").attr("value","")[0].value="";d.addClass("MultiFile-applied");d.change(function(){b(this).blur();if(!a.trigger("onFileSelect",this,a))return false;var i= "",f=String(this.value||"");if(a.accept&&f&&!f.match(a.rxAccept))i=a.STRING.denied.replace("$ext",String(f.match(/\.\w{1,4}$/gi)));for(var k in a.slaves)if(a.slaves[k]&&a.slaves[k]!=this)if(a.slaves[k].value==f)i=a.STRING.duplicate.replace("$file",f.match(/[^\/\\]+$/gi));f=b(a.clone).clone();f.addClass("MultiFile");if(i!=""){a.error(i);a.n--;a.addSlave(f[0],h);d.parent().prepend(f);d.remove();return false}b(this).css({position:"absolute",top:"-3000px"});d.after(f);a.addToList(this,h);a.addSlave(f[0], h+1);if(!a.trigger("afterFileSelect",this,a))return false});b(d).data("MultiFile",a)};a.addToList=function(d,h){if(!a.trigger("onFileAppend",d,a))return false;var i=b('<div class="MultiFile-label"></div>'),f=String(d.value||"");f=b('<span class="MultiFile-title" title="'+a.STRING.selected.replace("$file",f)+'">'+a.STRING.file.replace("$file",f.match(/[^\/\\]+$/gi)[0])+"</span>");var k=b('<a class="MultiFile-remove" href="#'+a.wrapID+'">'+a.STRING.remove+"</a>");a.list.append(i.append(k," ",f));k.click(function(){if(!a.trigger("onFileRemove", d,a))return false;a.n--;a.current.disabled=false;a.slaves[h]=null;b(d).remove();b(this).parent().remove();b(a.current).css({position:"",top:""});b(a.current).reset().val("").attr("value","")[0].value="";if(!a.trigger("afterFileRemove",d,a))return false;return false});if(!a.trigger("afterFileAppend",d,a))return false};a.MultiFile||a.addSlave(a.e,0);a.n++;a.E.data("MultiFile",a)})};b.extend(b.fn.MultiFile,{reset:function(){var c=b(this).data("MultiFile");c&&c.list.find("a.MultiFile-remove").click(); return b(this)},disableEmpty:function(c){c=(typeof c=="string"?c:"")||"mfD";var j=[];b("input:file.MultiFile").each(function(){if(b(this).val()=="")j[j.length]=this});return b(j).each(function(){this.disabled=true}).addClass(c)},reEnableEmpty:function(c){c=(typeof c=="string"?c:"")||"mfD";return b("input:file."+c).removeClass(c).each(function(){this.disabled=false})},intercepted:{},intercept:function(c,j,g){var a;g=g||[];if(g.constructor.toString().indexOf("Array")<0)g=[g];if(typeof c=="function"){b.fn.MultiFile.disableEmpty(); a=c.apply(j||window,g);setTimeout(function(){b.fn.MultiFile.reEnableEmpty()},1E3);return a}if(c.constructor.toString().indexOf("Array")<0)c=[c];for(g=0;g<c.length;g++)(j=c[g]+"")&&function(e){b.fn.MultiFile.intercepted[e]=b.fn[e]||function(){};b.fn[e]=function(){b.fn.MultiFile.disableEmpty();a=b.fn.MultiFile.intercepted[e].apply(this,arguments);setTimeout(function(){b.fn.MultiFile.reEnableEmpty()},1E3);return a}}(j)}});b.fn.MultiFile.options={accept:"",max:-1,namePattern:"$name_$i",STRING:{remove:"\u524a\u9664", denied:"You cannot select a $ext file.\nTry again...",file:"$file",selected:"File selected: $file",duplicate:"\u3053\u306e\u30d5\u30a1\u30a4\u30eb\u306f\u65e2\u306b\u9078\u629e\u3055\u308c\u3066\u3044\u307e\u3059:\n$file"},autoIntercept:["submit","ajaxSubmit","ajaxForm","validate","valid"],error:function(c){alert(c)}};b.fn.reset=function(){return this.each(function(){try{this.reset()}catch(c){}})};b(function(){b("input[type=file].multi").MultiFile()})}(jQuery);